<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPMDC Head Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .page-content {
            display: none;
        }
        .active-nav-link {
            background-color: #4A5568;
            color: #FFFFFF;
        }
        /* simple table styling for inserted descriptive section */
        .desc-table td, .desc-table th { padding: 6px 8px; border-bottom: 1px solid #f3f4f6; }
        .desc-summary { color:#374151; margin-bottom:8px }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-800 text-white flex flex-col">
            <div class="p-6 text-center border-b border-gray-700">
                <h2 class="text-xl font-semibold">OPMDC Head</h2>
                <p class="text-sm text-gray-400">Oversight Panel</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center px-4 py-2 rounded-md hover:bg-gray-700 active-nav-link" onclick="showPage('dashboard')">
                    <i class="fas fa-tachometer-alt w-5 mr-3"></i> Dashboard
                </a>
                <a href="#" class="flex items-center px-4 py-2 rounded-md hover:bg-gray-700" onclick="showPage('submissions')">
                    <i class="fas fa-file-alt w-5 mr-3"></i> Submissions
                </a>
                <a href="#" class="flex items-center px-4 py-2 rounded-md hover:bg-gray-700" onclick="showPage('resources')">
                    <i class="fas fa-cubes w-5 mr-3"></i> Resource Allocation
                </a>
                <a href="#" class="flex items-center px-4 py-2 rounded-md hover:bg-gray-700" onclick="showPage('planning')">
                    <i class="fas fa-calendar-alt w-5 mr-3"></i> Strategic Planning
                </a>
                <a href="#" class="flex items-center px-4 py-2 rounded-md hover:bg-gray-700" onclick="showPage('policies')">
                    <i class="fas fa-gavel w-5 mr-3"></i> Policy Development
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <a href="login.html" class="flex items-center w-full px-4 py-2 rounded-md text-red-400 hover:bg-red-500 hover:text-white">
                    <i class="fas fa-sign-out-alt w-5 mr-3"></i> Logout
                </a>
            </div>
        </aside>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200">
            <div class="container mx-auto px-6 py-8">
                
                <div id="dashboard" class="page-content" style="display: block;">
                    <div class="flex items-start justify-between">
                        <h3 class="text-3xl font-medium text-gray-700">Dashboard Analytics</h3>
                        <div class="relative">
                            <button id="headNotifBell" title="Notifications" class="relative p-2 rounded-full hover:bg-gray-100 focus:outline-none">
                                <i class="fas fa-bell text-gray-600 text-lg"></i>
                                <span id="headNotifBadge" class="notification-dot hidden"></span>
                            </button>
                            <div id="headNotifDropdown" class="hidden absolute right-0 mt-2 bg-white shadow-lg rounded-lg z-50 w-80">
                                <div class="p-3 border-b flex items-center justify-between"><strong>Notifications</strong><button id="headMarkAllRead" class="text-xs text-blue-600">Mark all read</button></div>
                                <div id="headNotifList" class="max-h-64 overflow-auto p-2"><div class="text-center text-gray-500">Loading…</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold text-gray-600">Total Submissions</h4>
                            <p class="text-3xl font-bold text-gray-800" id="card-total">142</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold text-gray-600">Pending Approvals</h4>
                            <p class="text-3xl font-bold text-yellow-500" id="card-pending">12</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold text-gray-600">Active Projects</h4>
                            <p class="text-3xl font-bold text-blue-500" id="card-active">35</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold text-gray-600">Registered Users</h4>
                            <p class="text-3xl font-bold text-green-500" id="card-users">89</p>
                        </div>
                    </div>

                    <!-- INSERTED: Descriptive Analytics Section -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-700">Descriptive Analytics</h4>
                        <div class="desc-summary" id="descSummary">Loading summary…</div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h5 class="text-sm text-gray-600 mb-2">By Type</h5>
                                <table class="w-full desc-table">
                                    <thead>
                                        <tr><th class="text-left text-xs text-gray-500">Type</th><th class="text-right text-xs text-gray-500">Count</th><th class="text-right text-xs text-gray-500">%</th></tr>
                                    </thead>
                                    <tbody id="tblByType"></tbody>
                                </table>
                            </div>

                            <div>
                                <h5 class="text-sm text-gray-600 mb-2">Top Barangays</h5>
                                <table class="w-full desc-table">
                                    <thead>
                                        <tr><th class="text-left text-xs text-gray-500">Barangay</th><th class="text-right text-xs text-gray-500">Count</th><th class="text-right text-xs text-gray-500">%</th></tr>
                                    </thead>
                                    <tbody id="tblTopBarangay"></tbody>
                                </table>
                            </div>

                            <div>
                                <h5 class="text-sm text-gray-600 mb-2">Review Time (mins)</h5>
                                <div id="reviewStats" class="text-sm text-gray-700"></div>
                            </div>
                        </div>
                    </div>
                    <!-- END INSERTED -->

                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <canvas id="requestStatusChart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <canvas id="accountStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="submissions" class="page-content">
                    <h3 class="text-3xl font-medium text-gray-700">Manage Submissions</h3>
                    <div class="mt-6 bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4">Project Name</th>
                                    <th class="py-3 px-4">Submitted By</th>
                                    <th class="py-3 px-4">Date</th>
                                    <th class="py-3 px-4">Status</th>
                                    <th class="py-3 px-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="submissions-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="resources" class="page-content">
                  <h3 class="text-3xl font-medium text-gray-700">Resource Allocation</h3>
                  <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
                      <table class="w-full text-sm text-left text-gray-500">
                          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                              <tr>
                                  <th class="py-3 px-4">Project/Department</th>
                                  <th class="py-3 px-4">Budget Allocated</th>
                                  <th class="py-3 px-4">Personnel</th>
                                  <th class="py-3 px-4">Status</th>
                              </tr>
                          </thead>
                          <tbody id="resource-table-body"></tbody>
                      </table>
                  </div>
                </div>

                <div id="planning" class="page-content">
                  <h3 class="text-3xl font-medium text-gray-700">Strategic Planning</h3>
                   <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
                      <table class="w-full text-sm text-left text-gray-500">
                          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                              <tr>
                                  <th class="py-3 px-4">Goal</th>
                                  <th class="py-3 px-4">Timeframe</th>
                                  <th class="py-3 px-4">KPIs</th>
                                  <th class="py-3 px-4">Status</th>
                              </tr>
                          </thead>
                          <tbody id="planning-table-body"></tbody>
                      </table>
                  </div>
                </div>
                
                <div id="policies" class="page-content">
                    <h3 class="text-3xl font-medium text-gray-700">Policy Development</h3>
                    <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
                      <table class="w-full text-sm text-left text-gray-500">
                          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                              <tr>
                                  <th class="py-3 px-4">Policy Name</th>
                                  <th class="py-3 px-4">Status</th>
                                  <th class="py-3 px-4">Last Updated</th>
                                  <th class="py-3 px-4">Actions</th>
                              </tr>
                          </thead>
                          <tbody id="policy-table-body"></tbody>
                      </table>
                  </div>
                </div>

            </div>
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mock data
        const mockData = {
            opmdcSubmissions: [
                { name: 'New Road Construction', submitter: 'John Doe', date: '2023-10-26', status: 'Pending' },
                { name: 'Community Center Upgrade', submitter: 'Jane Smith', date: '2023-10-25', status: 'Approved' },
            ],
            opmdcResources: [
                { project: 'IT Department', budget: '$50,000', personnel: '5', status: 'Ongoing' },
                { project: 'Roads Project', budget: '$200,000', personnel: '12', status: 'Completed' },
            ],
            opmdcPlanning: [
                { goal: 'Digitize Records', timeframe: 'Q4 2023', kpi: '90% digitized', status: 'On Track' },
                { goal: 'New Park', timeframe: 'Q1 2024', kpi: 'Land acquired', status: 'Delayed' },
            ],
            opmdcPolicies: [
                { name: 'Data Privacy Policy', status: 'Draft', updated: '2023-10-20' },
                { name: 'Procurement Guidelines', status: 'Active', updated: '2023-09-15' },
            ]
        };

        const loadGenericTable = (dataKey, tableBodyId, rowTemplate) => {
            const tableBody = document.getElementById(tableBodyId);
            if (tableBody && mockData[dataKey]) {
                tableBody.innerHTML = mockData[dataKey].map(rowTemplate).join('');
            }
        };

        // Load data into tables
        loadGenericTable('opmdcSubmissions', 'submissions-table-body', s => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4 font-medium">${s.name}</td><td class="py-3 px-4">${s.submitter}</td><td class="py-3 px-4">${s.date}</td><td class="py-3 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${s.status === 'Approved' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">${s.status}</span></td><td class="py-3 px-4"><button class="text-blue-500 hover:underline">View</button></td></tr>`);
        loadGenericTable('opmdcResources', 'resource-table-body', r => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4">${r.project}</td><td class="py-3 px-4">${r.budget}</td><td class="py-3 px-4">${r.personnel}</td><td class="py-3 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${r.status === 'Completed' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">${r.status}</span></td></tr>`);
        loadGenericTable('opmdcPlanning', 'planning-table-body', p => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4 font-medium">${p.goal}</td><td class="py-3 px-4">${p.timeframe}</td><td class="py-3 px-4">${p.kpi}</td><td class="py-3 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${p.status === 'On Track' ? 'bg-blue-200 text-blue-800' : 'bg-red-200 text-red-800'}">${p.status}</span></td></tr>`);
        loadGenericTable('opmdcPolicies', 'policy-table-body', p => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4">${p.name}</td><td class="py-3 px-4">${p.status}</td><td class="py-3 px-4">${p.updated}</td><td class="py-3 px-4"><button class="text-blue-500 hover:underline">Edit</button></td></tr>`);

        // Charts
        const requestCtx = document.getElementById('requestStatusChart')?.getContext('2d');
        if(requestCtx) {
            new Chart(requestCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Approved', 'Pending', 'Declined'],
                    datasets: [{
                        data: [85, 12, 3],
                        backgroundColor: ['#4CAF50', '#FFC107', '#F44336'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Request Status Distribution' }
                    }
                }
            });
        }

        const accountCtx = document.getElementById('accountStatusChart')?.getContext('2d');
        if(accountCtx) {
            new Chart(accountCtx, {
                type: 'bar',
                data: {
                    labels: ['Barangay Official', 'OPMDC Staff', 'OPMDC Head'],
                    datasets: [{
                        label: 'Active Accounts',
                        data: [50, 35, 4],
                        backgroundColor: '#3B82F6',
                    }]
                },  
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Account Status by Role' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Load descriptive analytics (tries API, falls back to mock)
        async function loadDescriptive() {
            const summaryEl = document.getElementById('descSummary');
            try {
                const res = await fetch('get_descriptive.php');
                if (!res.ok) throw new Error('API not available');
                const data = await res.json();
                summaryEl.innerText = data.summary || 'No summary available.';

                // by type
                const tbType = document.getElementById('tblByType');
                tbType.innerHTML = '';
                (data.by_type || []).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.type || '-'}</td><td style="text-align:right">${r.count}</td><td style="text-align:right">${r.pct}%</td>`;
                    tbType.appendChild(tr);
                });

                // top barangays
                const tbB = document.getElementById('tblTopBarangay');
                tbB.innerHTML = '';
                (data.top_barangays || []).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.barangay}</td><td style="text-align:right">${r.count}</td><td style="text-align:right">${r.pct}%</td>`;
                    tbB.appendChild(tr);
                });

                // review time
                const rt = data.review_time || {};
                const reviewDiv = document.getElementById('reviewStats');
                if (rt.count && rt.count > 0) {
                    reviewDiv.innerHTML = `Count: ${rt.count}<br>Avg: ${rt.avg_minutes} min<br>Median: ${rt.median_minutes} min<br>Stddev: ${rt.stddev_minutes} min<br>Mode (approx): ${rt.mode_minutes} min`;
                } else {
                    reviewDiv.innerText = 'No reviewed proposals in range.';
                }

                // update cards if data available
                if (typeof data.total !== 'undefined') document.getElementById('card-total').innerText = data.total;
                if (typeof data.status_counts !== 'undefined') {
                    const pending = data.total - (data.status_counts.approved + data.status_counts.denied || 0);
                    document.getElementById('card-pending').innerText = pending;
                }

            } catch (err) {
                // fallback: show sample descriptive info if API not present
                summaryEl.innerText = 'Could not reach analytics API — showing sample data.';
                const sampleByType = [{type:'CLUP',count:70,pct:49.3},{type:'CDP',count:45,pct:31.7},{type:'AIP',count:27,pct:19.0}];
                const tbType = document.getElementById('tblByType'); tbType.innerHTML = '';
                sampleByType.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.type}</td><td style="text-align:right">${r.count}</td><td style="text-align:right">${r.pct}%</td>`; tbType.appendChild(tr); });
                const sampleTop = [{barangay:'Laurel',count:34,pct:23.9},{barangay:'Poblacion',count:28,pct:19.7},{barangay:'Bulacan',count:18,pct:12.7}];
                const tbB = document.getElementById('tblTopBarangay'); tbB.innerHTML = '';
                sampleTop.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.barangay}</td><td style="text-align:right">${r.count}</td><td style="text-align:right">${r.pct}%</td>`; tbB.appendChild(tr); });
                document.getElementById('reviewStats').innerText = 'Sample — Avg: 180 min, Median: 120 min';
            }
        }

        // initial descriptive load (after charts)
        loadDescriptive();
    });

    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
        document.getElementById(pageId).style.display = 'block';

        document.querySelectorAll('nav a').forEach(link => {
            link.classList.remove('active-nav-link');
            if(link.getAttribute('onclick').includes(pageId)) {
                link.classList.add('active-nav-link');
            }
        });
    }
</script>
<script>
// Head notifications
document.addEventListener('DOMContentLoaded', () => {
    const headBell = document.getElementById('headNotifBell');
    const headBadge = document.getElementById('headNotifBadge');
    const headDropdown = document.getElementById('headNotifDropdown');
    const headList = document.getElementById('headNotifList');
    const headMarkAllRead = document.getElementById('headMarkAllRead');

    async function fetchHeadNotifs() {
        try {
            const res = await fetch('notifications.php?role=' + encodeURIComponent('OPMDC Head'));
            const data = await res.json();
            renderHeadNotifs(data.notifications || []);
        } catch (err) {
            headList.innerHTML = '<div class="text-center text-gray-500">Could not load notifications</div>';
        }
    }

    function renderHeadNotifs(notes) {
        if (!notes.length) { headList.innerHTML = '<div class="text-center text-gray-500">No notifications.</div>'; headBadge.classList.add('hidden'); return; }
        const unread = notes.filter(n => n.is_read == 0).length;
        if (unread > 0) headBadge.classList.remove('hidden'); else headBadge.classList.add('hidden');
        headList.innerHTML = '';
        notes.forEach(n => {
            const div = document.createElement('div');
            div.className = 'p-2 border-b';
            div.innerHTML = `<div class="flex justify-between"><div><strong>${escapeHtml(n.title)}</strong><div class="text-xs text-gray-600">${escapeHtml(n.body)}</div><div class="text-xs text-gray-400 mt-1">${n.created_at}</div></div><div class="flex flex-col items-end space-y-1"><button class="mark-read text-xs text-blue-600" data-id="${n.id}">${n.is_read==0? 'Mark read':'Unread'}</button><button class="delete text-xs text-red-600" data-id="${n.id}">Delete</button></div></div>`;
            headList.appendChild(div);
        });
        headList.querySelectorAll('.mark-read').forEach(btn => btn.addEventListener('click', async (e) => { const id = e.target.dataset.id; await fetch('notifications_mark_read.php?id=' + encodeURIComponent(id), { method: 'POST' }); fetchHeadNotifs(); }));
        headList.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async (e) => { const id = e.target.dataset.id; await fetch('notifications_delete.php?id=' + encodeURIComponent(id), { method: 'POST' }); fetchHeadNotifs(); }));
    }

    headBell && headBell.addEventListener('click', (e) => { e.stopPropagation(); headDropdown.classList.toggle('hidden'); if (!headDropdown.classList.contains('hidden')) fetchHeadNotifs(); });
    document.addEventListener('click', () => headDropdown.classList.add('hidden'));
    headMarkAllRead && headMarkAllRead.addEventListener('click', async () => { const res = await fetch('notifications.php?role=' + encodeURIComponent('OPMDC Head')); const data = await res.json(); for (const n of data.notifications || []) { await fetch('notifications_mark_read.php?id=' + encodeURIComponent(n.id), { method: 'POST' }); } fetchHeadNotifs(); });

    function escapeHtml(s) { return String(s).replace(/[&<>\"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]; }); }

    fetchHeadNotifs();
});
</script>
</body> 
</html>
